const std = @import("std");
const Allocator = std.mem.Allocator;

const root = @import("root");

const PATH = "src/physical_device_features.zig";
const HEADER =
    \\// This file is auto generated by gen/{s}
    \\
    \\const std = @import("std");
    \\const vk = @import("volk");
    \\const log = @import("log.zig");
    \\
    \\
;

pub fn gen() !void {
    std.fs.cwd().deleteFile(PATH) catch {};
    const file = try std.fs.cwd().createFile(PATH, .{});
    defer file.close();

    _ = try file.write(root.NOTE);
    const header = std.fmt.comptimePrint(HEADER, .{@src().file});
    _ = try file.write(header);
    try write_physical_device_struct(&file, &.{
        "VkPhysicalDevice16BitStorageFeatures",
        "VkPhysicalDeviceMultiviewFeatures",
        "VkPhysicalDeviceVariablePointersFeatures",
        "VkPhysicalDeviceSamplerYcbcrConversionFeatures",
        "VkPhysicalDeviceShaderDrawParametersFeatures",
        "VkPhysicalDevice8BitStorageFeatures",
        "VkPhysicalDeviceShaderAtomicInt64Features",
        "VkPhysicalDeviceShaderFloat16Int8Features",
        "VkPhysicalDeviceDescriptorIndexingFeatures",
        "VkPhysicalDeviceVulkanMemoryModelFeatures",
        "VkPhysicalDeviceUniformBufferStandardLayoutFeatures",
        "VkPhysicalDeviceShaderSubgroupExtendedTypesFeatures",
        "VkPhysicalDeviceSeparateDepthStencilLayoutsFeatures",
        "VkPhysicalDeviceBufferDeviceAddressFeatures",
        "VkPhysicalDeviceShaderClockFeaturesKHR",
        "VkPhysicalDeviceFragmentShadingRateFeaturesKHR",
        "VkPhysicalDeviceRayQueryFeaturesKHR",
        "VkPhysicalDeviceRayTracingPipelineFeaturesKHR",
        "VkPhysicalDeviceAccelerationStructureFeaturesKHR",
        "VkPhysicalDeviceWorkgroupMemoryExplicitLayoutFeaturesKHR",
        "VkPhysicalDeviceShaderIntegerDotProductFeaturesKHR",
        "VkPhysicalDeviceSynchronization2FeaturesKHR",
        "VkPhysicalDeviceDynamicRenderingFeaturesKHR",
        "VkPhysicalDeviceMaintenance4FeaturesKHR",
        "VkPhysicalDeviceMaintenance5FeaturesKHR",
        "VkPhysicalDeviceMaintenance7FeaturesKHR",
        "VkPhysicalDeviceZeroInitializeWorkgroupMemoryFeaturesKHR",
        "VkPhysicalDeviceTransformFeedbackFeaturesEXT",
        "VkPhysicalDeviceDepthClipEnableFeaturesEXT",
        "VkPhysicalDeviceInlineUniformBlockFeaturesEXT",
        "VkPhysicalDeviceBlendOperationAdvancedFeaturesEXT",
        "VkPhysicalDeviceVertexAttributeDivisorFeaturesKHR",
        "VkPhysicalDeviceShaderDemoteToHelperInvocationFeaturesEXT",
        "VkPhysicalDeviceFragmentShaderInterlockFeaturesEXT",
        "VkPhysicalDeviceFragmentDensityMapFeaturesEXT",
        "VkPhysicalDeviceBufferDeviceAddressFeaturesEXT",
        "VkPhysicalDeviceLineRasterizationFeaturesKHR",
        "VkPhysicalDeviceSubgroupSizeControlFeaturesEXT",
        "VkPhysicalDeviceExtendedDynamicStateFeaturesEXT",
        "VkPhysicalDeviceExtendedDynamicState2FeaturesEXT",
        "VkPhysicalDeviceExtendedDynamicState3FeaturesEXT",
        "VkPhysicalDeviceVertexInputDynamicStateFeaturesEXT",
        "VkPhysicalDeviceColorWriteEnableFeaturesEXT",
        "VkPhysicalDeviceShaderImageAtomicInt64FeaturesEXT",
        "VkPhysicalDeviceShaderAtomicFloatFeaturesEXT",
        "VkPhysicalDeviceShaderAtomicFloat2FeaturesEXT",
        "VkPhysicalDeviceProvokingVertexFeaturesEXT",
        "VkPhysicalDeviceCustomBorderColorFeaturesEXT",
        "VkPhysicalDeviceComputeShaderDerivativesFeaturesKHR",
        "VkPhysicalDeviceFragmentShaderBarycentricFeaturesKHR",
        "VkPhysicalDeviceShaderImageFootprintFeaturesNV",
        "VkPhysicalDeviceShadingRateImageFeaturesNV",
        "VkPhysicalDeviceCooperativeMatrixFeaturesNV",
        "VkPhysicalDeviceShaderSMBuiltinsFeaturesNV",
        "VkPhysicalDeviceShaderIntegerFunctions2FeaturesINTEL",
        "VkPhysicalDeviceMutableDescriptorTypeFeaturesEXT",
        "VkPhysicalDeviceRobustness2FeaturesEXT",
        "VkPhysicalDeviceImageRobustnessFeaturesEXT",
        "VkPhysicalDeviceGraphicsPipelineLibraryFeaturesEXT",
        "VkPhysicalDeviceFragmentShadingRateEnumsFeaturesNV",
        "VkPhysicalDeviceDepthClipControlFeaturesEXT",
        "VkPhysicalDeviceMeshShaderFeaturesNV",
        "VkPhysicalDeviceMeshShaderFeaturesEXT",
        "VkPhysicalDeviceDescriptorBufferFeaturesEXT",
        "VkPhysicalDeviceNonSeamlessCubeMapFeaturesEXT",
        "VkPhysicalDeviceAttachmentFeedbackLoopLayoutFeaturesEXT",
        "VkPhysicalDeviceShaderModuleIdentifierFeaturesEXT",
        "VkPhysicalDeviceRayTracingMaintenance1FeaturesKHR",
        "VkPhysicalDeviceRayTracingMotionBlurFeaturesNV",
        "VkPhysicalDeviceImageProcessingFeaturesQCOM",
        "VkPhysicalDeviceImageProcessing2FeaturesQCOM",
        "VkPhysicalDeviceShaderCoreBuiltinsFeaturesARM",
        "VkPhysicalDeviceRayTracingPositionFetchFeaturesKHR",
        "VkPhysicalDeviceShaderTileImageFeaturesEXT",
        "VkPhysicalDeviceCooperativeMatrixFeaturesKHR",
        "VkPhysicalDeviceShaderSubgroupRotateFeaturesKHR",
        "VkPhysicalDeviceShaderExpectAssumeFeaturesKHR",
        "VkPhysicalDeviceShaderFloatControls2FeaturesKHR",
        "VkPhysicalDeviceShaderQuadControlFeaturesKHR",
        "VkPhysicalDeviceRawAccessChainsFeaturesNV",
        "VkPhysicalDeviceShaderReplicatedCompositesFeaturesEXT",
        "VkPhysicalDevicePipelineRobustnessFeaturesEXT",
        "VkPhysicalDeviceConditionalRenderingFeaturesEXT",
        "VkPhysicalDeviceDynamicRenderingLocalReadFeaturesKHR",
        "VkPhysicalDeviceRasterizationOrderAttachmentAccessFeaturesEXT",
        "VkPhysicalDeviceOpacityMicromapFeaturesEXT",
        "VkPhysicalDeviceDeviceGeneratedCommandsFeaturesNV",
        "VkPhysicalDeviceDeviceGeneratedCommandsComputeFeaturesNV",
        "VkPhysicalDeviceOpticalFlowFeaturesNV",
        "VkPhysicalDeviceLegacyDitheringFeaturesEXT",
        "VkPhysicalDevicePipelineProtectedAccessFeaturesEXT",
        "VkPhysicalDevicePerStageDescriptorSetFeaturesNV",
        "VkPhysicalDeviceAttachmentFeedbackLoopDynamicStateFeaturesEXT",
        "VkPhysicalDeviceSubpassMergeFeedbackFeaturesEXT",
        "VkPhysicalDeviceBorderColorSwizzleFeaturesEXT",
        "VkPhysicalDeviceMultisampledRenderToSingleSampledFeaturesEXT",
        "VkPhysicalDeviceDepthBiasControlFeaturesEXT",
        "VkPhysicalDeviceDepthClampControlFeaturesEXT",
        "VkPhysicalDeviceDeviceGeneratedCommandsFeaturesEXT",
        "VkPhysicalDeviceShaderObjectFeaturesEXT",
        "VkPhysicalDevicePrimitivesGeneratedQueryFeaturesEXT",
        "VkPhysicalDeviceImage2DViewOf3DFeaturesEXT",
        "VkPhysicalDeviceScalarBlockLayoutFeaturesEXT",
        "VkPhysicalDeviceShaderBfloat16FeaturesKHR",
        "VkPhysicalDeviceCooperativeMatrix2FeaturesNV",
        "VkPhysicalDeviceRayTracingLinearSweptSpheresFeaturesNV",
        "VkPhysicalDeviceClusterAccelerationStructureFeaturesNV",
        "VkPhysicalDeviceCooperativeVectorFeaturesNV",
        "VkPhysicalDeviceTileShadingFeaturesQCOM",
        "VkPhysicalDeviceShaderFloat8FeaturesEXT",
        "VkPhysicalDeviceTensorFeaturesARM",
        "VkPhysicalDeviceZeroInitializeDeviceMemoryFeaturesEXT",
        "VkPhysicalDevicePipelineOpacityMicromapFeaturesARM",
        "VkPhysicalDevicePartitionedAccelerationStructureFeaturesNV",
        "VkPhysicalDeviceFragmentDensityMapLayeredFeaturesVALVE",
    });
}

fn write_physical_device_struct(file: *const std.fs.File, types: []const []const u8) !void {
    var arena = std.heap.ArenaAllocator.init(std.heap.page_allocator);
    const alloc = arena.allocator();

    for (types) |t| {
        defer _ = arena.reset(.retain_capacity);

        const name = try root.format_name(alloc, t, false);
        // const name = try get_field_name(alloc, t);
        const stype = try root.get_stype(alloc, t);
        const line = try std.fmt.allocPrint(alloc,
            \\{s}: vk.{s} =
            \\    .{{ .sType = vk.{s} }},
            \\
        , .{ name, t, stype });
        _ = try file.write(line);
    }
    _ = try file.write("\n");

    _ = try file.write(
        \\pub fn chain_supported(features: *@This(), extensions: [][*c]const u8) ?*anyopaque {
        \\    var pnext: ?*anyopaque = null;
        \\    for (extensions) |ext| {
        \\        const e = std.mem.span(ext);
        \\
    );
    for (0..types.len) |i| {
        defer _ = arena.reset(.retain_capacity);

        const t = types[types.len - i - 1];
        const name = try root.format_name(alloc, t, false);
        const extension = try root.get_extension(alloc, t);
        const line = try std.fmt.allocPrint(
            alloc,
            \\        if (std.mem.eql(u8, e, vk.{s})) {{
            \\            log.debug(@src(), "Adding {{s}} extension to the physical device features pnext chain", .{{vk.{s}}});
            \\            features.{s}.pNext = pnext;
            \\            pnext = &features.{s};
            \\            continue;
            \\        }}
            \\
        ,
            .{ extension, extension, name, name },
        );
        _ = try file.write(line);
    }
    _ = try file.write(
        \\    }
        \\    return pnext;
        \\}
        \\
    );
}
